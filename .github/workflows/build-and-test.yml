name: Build and Test VOLT Firmware

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Cache PlatformIO
      uses: actions/cache@v5.0.2
      with:
        path: |
          ~/.platformio
          .pio
        key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        cache: 'pip'
    
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
    
    - name: Build firmware
      run: |
        # Check if platformio.ini exists
        if [ -f "platformio.ini" ]; then
          pio run
        else
          echo "No platformio.ini found - skipping build"
        fi
    
    - name: Run Python tests
      run: |
        if [ -f "run_all_tests.py" ]; then
          pip install -r requirements.txt || true
          python run_all_tests.py || true
        fi
    
    - name: Archive firmware
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: volt-firmware
        path: |
          .pio/build/**/firmware.bin
          .pio/build/**/firmware.elf
        retention-days: 30
    
    - name: Create release on tag
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          .pio/build/**/firmware.bin
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  documentation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate documentation
      run: |
        echo "Checking for required documentation files..."
        files=(
          "README.md"
          "HOW_TO_FLASH.md"
          "VOICE_OPTIONS.md"
        )
        
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "✅ $file exists"
          else
            echo "❌ $file missing"
            exit 1
          fi
        done
    
    - name: Check markdown links
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        config-file: '.github/markdown-link-check-config.json'
      continue-on-error: true
